# Проект по определению оттока клиентов (бинарная классификация)
<p>Перед нами стояла задача прогнозирования оттока клиентов целью разработки предложений (промокодов и специальных условий), направленных на их удержание.
Компания предоставляет 2 основных типа услуг: Стационарную телефонную связь и Интернет.
В нашем распоряжении имелись 4 таблицы, содержащие информацию о договоре, персональных данных клиента, об интернет-услугах, об услугах телефонии, все таблицы связаны по ключу – уникальный идентификатор пользователя.
<p><b>Первичный осмотр данных</b> показал, что датасет contract представлен 7043 строками - id уникальных пользователей. Пропущенных значений нет; в столбце дата окончания есть значение 'no', что означает, что клиент еще не ушел; все столбцы, кроме ежемесячного платежа в формате object. Строки-дубликаты отсутствуют. 
Датасет persona представлен 7043 строками - id уникальных пользователей. Пропущенных значений нет; все столбцы, кроме пенсионного статуса в формате object. Строки-дубликаты отсутствуют. 
Датасет internet представлен 5517 строками - id уникальных пользователей. Надо отметить, что это меньшее количество, чем в таблице с контрактами, следовательно, не все пользователи подключили интернет. Пропущенных значений нет; все столбцы имеют тип данных object.
Датасет phone представлен 6361 строками - id уникальных пользователей. Надо отметить, что это меньшее количество, чем в таблице с контрактами и интернетом, следовательно, не все пользователи имеют стационарную телефонную связь. Как и в предыдущих датасетах; пропущенных значений нет; строк-дубликатов нет; столбцы имеют тип данных object..

<p>Далее была выполнена <b>первичная предобработка данных</b>.
<p>1) Объединили 4 таблицы в одну. Получили 19 признаков, пропущенные значения в столбцах с признаками, относящимся к интернету или телефонии; обнаружилось 4 дубликата - пользоватлели, имеющие одинаковые характеристики, хотя это разные люди, для моделирования удалили их.
<p>2) Привели заголовки столбцов к «змеиному» регистру для удобства.
<p>3) Добавили целевой признак: ушел клиент (1) или нет( 0) н на момент скачивания данных.
<p>4) Клиенты с незаполненным значением total_charges заключили договор в день скачивания анкеты, у всех контракт на 2 года, ежемесячный платеж осуществлен. Можно было бы заполнить пропущенные значения значением ежемесячного платежа, однако, это всего 11 пользователей, которые к тому же, только пришли, и заключили долгосрочный контракт, удалили их, так как информативности при моделировании от них немного (и их незначительное количество). Тип данных столбца "TotalCharges" изменили на float.
<p>5) изменили тип данных в столбцах со временем начала и окончания договора.

<p>Результаты <b>разведывательного анализа данных</b>.
<p>1)	Соотношение клиентов-мужчин и женщин практически одинаковое. Около 16% клиентов-пенсионеров; 48% людей имеют супруга(у). Большая часть (70%) клиентов не обременена иждивенцами. Более половины (55%) используют ежемесячный тип оплаты, договоры на два года и на год заключают примерно одинаковое количество людей (24% и 21%). Электронный платежный документ получает 59% клиентов, среди доминирующего способа оплаты можно выделить Electronic check (34%), остальные имеют равную долю (22-23%). У клиентов, подключивших Интернет (их 78%), преобладающий тип соединения – оптоволокно (44%), услуга по блокировке небезопасных сайтов подключена только у 29% , облачное хранилище данных – у 34%, антивирус – также у 34% . Выделенную линию техподдержки имеют 29% клиентов, стриминговое телевидение – у 38%, каталог фильмов – у 39% клиентов, наличие ведения параллельных линий во время звонка – у 42%.
<p>2)	При рассмотрении доли оттока по значениям признаков, определили, что наибольшая доля у клиентов, использующих услуги: online_backup (23,1%), multiple_lines (22,86%), device_protection (22,75%), а также тип оплаты – на два года (22,63%). 
<p>3)	Так как в чистом виде даты начала и конца действия договора не несут смысловой нагрузки, нами был рассчитан и добавлен новый признак «период действия договора в днях» (diff_date). Так как мы его ввели, чтобы избавиться от утечки данных, удалили признаки, несущие дату начала и дату окончания действия договора.
<p>4)	Было установлено, что максимальный срок действия договора - 2314 дня, минимальное - 28 дней, среднее значение - 900 дней, медианное - 761 день. Наблюдается правостороннее распределение.
<p>5)	Максимальный ежемесячный платеж 118,75, минимальный - 18,25. Среднее значение платежа - 64,8, медианное - 70,35. Наблюдается левостороннее распределение данных. Максимальное количество потраченных денег 9221,38, минимальное - 19,05. Среднее значение - 2118,39, медианное - 1345,27. Наблюдается правостороннее распределение данных.
<p>6)	Было установлено, что имеется сильная связь между общими затратами и тем, сколько клиент был в компании, при этом, видно, что чем дольше клиент в компании, тем меньше количества уходов. Также имеется зависимость между ежемесячным платежем и общим, а также то, что чем больше ежемесячный платеж, тем больше количество клиентов, ушедших из компании. В связи с этим, мы удалили признак с общими платежами с целью уменьшения признакового пространства.
<p>7)	Пропущенные значения в признаках, связанных с Интернетом и телефонией решили заполнить значением «No».
<p>8)	Так как у нас бинароное значение признака senior_citizen, но он является категориальным, заменили значенния 1 и 0 на 'Yes', 'No' соответственно.
<p>9)	Матрица фик-корреляции показала, что сильная связь имеется между ежемесячными платежами и признаком internet_service (0,95). Это логично, так как именно за эти услуги платит клиент. Так как у нас есть отдельные признаки, входящие по интернет-услугам, удалили признак internet_service.
<p>10)	Ярко выраженный дисбаланс классов по целевому признаку, на долю оттока приходится всего 15,6% данных. Несмотря на то, что метрика AUC-ROC не чувствительна к дисбалансу, при подборе гиперпараметров, рассмотрим варианты: без баланса и с ним. 

<p><b>Моделирование</b>
<p>Разбили данные на тренировочную и тестовую выборки.Определили признаки для обучения: категориальные ('gender', 'senior_citizen', 'partner', 'dependents', 'type', 'paper_less_billing', 'payment_method',
 'online_security', 'online_backup', 'device_protection', 'tech_support', 'streaming_tv', 'streaming_movies', 'multiple_lines') и числовые ('monthly_charges', 'diff_date'). 
<p>В качестве моделей для обучения решили использовать 3 модели: RandomForestClassifier, CatBoostClassifier, LGBMClassifier. 

<p>Для модели RandomForestClassifier был создан пайплайн для предварительного кодирования. Так как данных не очень много, решили взять OneHotEncoder. Для подбора гиперпараметров использовали GridSearchCV. Гиперпараметры ('n_estimators': range(50, 100, 5), 'max_depth': range(2, 10), 'class_weight': ['balanced', None]). Модель показала неудовлетворительный результат - AUC-ROC для RandomForestClassifier: 0.7122, при гиперпараметрах (regressor__class_weight - balanced, regressor__max_depth – 5, regressor__n_estimators – 80).

<p>Для подбора гиперпараметров для модели CatBoostClassifier использовали Optuna. Гиперпараметры ('learning_rate' (0.1, 0.3, step=0.05), 'depth' (2, 10, step=1), 'scale_pos_weight' (1, 6)). Модель показала на тренировочной выборке хороший результат - 0.9223 с гиперпараметрами (learning_rate - 0.150000, depth - 2.000000, scale_pos_weight - 2.146398).

<p>Для подбора гиперпараметров для модели LGBMClassifier использовали также Optuna. Гиперпараметры ('learning_rate' (0.1, 0.3, step=0.05), 'max_depth' (2, 10, step=1), 'scale_pos_weight' (1, 6)). Результа получился хуже, чем у CatBoostClassifier, но лучше, чем у модели RandomForestClassifier - 0.8788 с гиперпараметрами: learning_rate - 0.20000, max_depth - 4.00000, scale_pos_weight - 1.55883.
Таким образом, для тестирования мы выбрали модель CatBoostClassifier. На тесте модель показала очень хороший результат: roc_auc = 0.94 (модель одинаково хорошо определяет положительный и отрицательный класс), при техзадании (не менее 0,85). Это также подтверждает Accuracy = 0.93 (правильный класс определяется примерно для 93% данных).

<p>Построили ROC-кривую, для сравнения со случайным классификатором (проверка на адекватность модели).

<p>При построении матрицы ошибок, установили, что наша модель верно предсказала 1449 значения - что не уйдет человек и 197 - что уйдет. У 33 значений модель предсказала, что человек уйдет, а на самом деле он не ушел (это может дать компании дополнительные затраты при удержании этих клиентов). В 78 случаев модель ошиблась и не определила клиентов, которые ушли.

<p>Оценка важности признаков показала, что наиболее важным признаком является - время, сколько человек является клиентом, на втором месте - ежемесячные платежи, на 3 - тип оплаты (помесячная, на год-два). Остальные признаки менее значительны. Это может дать основу для формирования маркетинговой стратегии, основанной на удержании клиента за счет снижения платежа, при заключении долгосрочного договора.

<p>Таким образом, наша модель соответствует заявленным критериям. Полученная информация о важности признаков должна лечь в основу разработки тарифов и маркетинговых мероприятий по удержанию и привлечению клиентов. Например, скидка, при заключении договора на два и более года, бесплатные дополнительные услуги для постоянных клиентов и др.